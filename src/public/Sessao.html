<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sessão - EduMentor</title>
  <link rel="stylesheet" href="./css/Sessao.css">
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="logo"><a href="/">EduMentor</a></div>
    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/meu-perfil">Meu Perfil</a></li>
        <li><a href="#">Sair</a></li>
      </ul>
    </nav>
  </header>

    <main class="sessao-container">
        <div class="video-call" id="iniciar-video-call">
      <img src="/src/public/img/call.jpg" alt="Clique para iniciar a Video Chamada">
    </div>

        <div class="chat-container">
      <div class="chat-messages" id="chat-messages">
        <div class="message mentor">Olá! Pronto para a aula?</div>
      </div>
      <div class="chat-input">
        <input type="text" id="mensagem" placeholder="Digite sua mensagem...">
        <button onclick="enviarMensagem()">Enviar</button>
      </div>
      <div class="encerrar-container">
            <button id="encerrar-sessao">Encerrar Sessão</button>
        </div>

    </div>
    <div id="avaliacao-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Avalie a Sessão</h2>
            <div class="estrelas">
                <span data-value="1">&#9733;</span>
                <span data-value="2">&#9733;</span>
                <span data-value="3">&#9733;</span>
                <span data-value="4">&#9733;</span>
                <span data-value="5">&#9733;</span>
            </div>
            <button id="enviar-avaliacao">Enviar Avaliação</button>
        </div>
    </div>

  </main>

  <script>
    // VARIÁVEL GLOBAL para monitorar a janela do Meet
    let meetWindow = null;
    const videoCallElement = document.getElementById('iniciar-video-call');
    const modal = document.getElementById('avaliacao-modal');

    // Função de Chat (Mantida)
    function enviarMensagem() {
      const input = document.getElementById('mensagem');
      const texto = input.value.trim();
      if(texto === '') return;
      const chat = document.getElementById('chat-messages');
      const novaMsg = document.createElement('div');
      novaMsg.className = 'message aluno';
      novaMsg.textContent = texto;
      chat.appendChild(novaMsg);
      chat.scrollTop = chat.scrollHeight;
      input.value = '';
    }

    // NOVO: Função que abre o Meet e monitora o fechamento da janela
    function iniciarSessaoComMonitor() {
        // 1. Abre a nova janela do Meet
        meetWindow = window.open('https://meet.new', 'meetSession', 'width=800,height=600,resizable=yes');

        if (meetWindow === null || meetWindow.closed) {
            alert("O navegador bloqueou a janela da videochamada. Por favor, desative o bloqueador de pop-ups e tente novamente.");
            return;
        }

        // Desativa o clique na área de vídeo para evitar reabrir enquanto a sessão está ativa
        videoCallElement.style.pointerEvents = 'none';
        
        // 2. Inicia o monitor de fechamento/retorno
        const monitorInterval = setInterval(() => {
            // Verifica se a janela aberta foi fechada
            if (meetWindow.closed) {
                clearInterval(monitorInterval); // Para de checar
                
                // 3. Exibe o modal de avaliação
                modal.style.display = 'flex';
                
                // 4. Volta para a página anterior (ex: Agendamento.html)
                window.history.back(); 

                // 5. Reabilita o clique
                videoCallElement.style.pointerEvents = 'auto'; 

                console.log("Sessão do Meet encerrada. Voltando e abrindo avaliação.");
            }
        }, 1000); // Checa a cada 1 segundo
    }


    // Lógica do Modal/Avaliação (Existente)
    const botaoEncerrar = document.getElementById('encerrar-sessao');
    const fecharModal = document.querySelector('.modal .close');
    const estrelas = document.querySelectorAll('.estrelas span');
    let avaliacao = 0;


    // Botão Encerrar Sessão (manual)
    botaoEncerrar.addEventListener('click', () => {
      modal.style.display = 'flex';
    });

    // Fechar modal
    fecharModal.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    // Selecionar estrelas
    estrelas.forEach(estrela => {
      estrela.addEventListener('mouseover', () => {
        estrelas.forEach(s => s.classList.remove('hover'));
        for (let i = 0; i < estrela.dataset.value; i++) {
          estrelas[i].classList.add('hover');
        }
      });

      estrela.addEventListener('mouseout', () => {
        estrelas.forEach(s => s.classList.remove('hover'));
      });

      estrela.addEventListener('click', () => {
        avaliacao = estrela.dataset.value;
        estrelas.forEach(s => s.classList.remove('selected'));
        for (let i = 0; i < avaliacao; i++) {
          estrelas[i].classList.add('selected');
        }
      });
    });

    // Enviar avaliação
    document.getElementById('enviar-avaliacao').addEventListener('click', () => {
      alert(`Obrigado pela sua avaliação de ${avaliacao} estrela(s)!`);
      modal.style.display = 'none';
    });

    // ADICIONA O EVENTO PRINCIPAL: Inicia a chamada ao clicar na área de vídeo
    videoCallElement.addEventListener('click', iniciarSessaoComMonitor);

  </script>
</body>
</html>